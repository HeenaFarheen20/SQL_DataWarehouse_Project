Create view gold.dim_customers as
Select 
    ROW_NUMBER() OVER (Order by cst_id) as Customer_key, 
	ci.cst_id as Customer_id,
	ci.cst_key as Customer_number,
	ci.cst_firstname as First_name,
	ci.cst_lastname as last_name,
	la.CNTRY as Country,
	ci.cst_marital_status as Martial_status,
	CASE when ci.cst_gndr != 'n/a' Then ci.cst_gndr -- CRM is the MAster for gender
          else coalesce(ca.gen, 'n/a')
	End as Gender,
	ca.BDATE as Birthdate,
	ci.cst_create_date as Create_date
	from Silver.crm_cust_info ci
	left join Silver.erp_cust_az12 ca
	on ci.cst_key = ca.CID
	left join Silver.erp_loc_a101 la
	on ci.cst_key = la.CID;

Select * from Gold.dim_customers;


--- Transformation------------------
Select Distinct 
ci.cst_gndr,
ca.gen,
CASE when ci.cst_gndr != 'n/a' Then ci.cst_gndr
     else coalesce(ca.gen, 'n/a')
	End as new_gen
from Silver.crm_cust_info ci
	left join Silver.erp_cust_az12 ca
	on ci.cst_key = ca.CID
	left join Silver.erp_loc_a101 la
	on ci.cst_key = la.CID
order by 1,2;

create view gold.dim_products as
Select 
ROW_NUMBER() over(order by pn.prd_start_dt, pn.prd_key) as product_key,
pn.prd_id as product_id,
pn.prd_key as product_number,
pn.prd_nm as product_name,
pn.cat_id as category_id,
pc.CAT as category,
pc.SUBCAT as subcategory,
pc.MAINTENANCE as maintenance,
pn.prd_cost as cost,
pn.prd_line as product_line,
pn.prd_start_dt as start_date
from 
Silver.crm_prd_info pn
left join
Silver.erp_px_cat_g1v2 pc
on pn.cat_id = pc.ID
where prd_end_dt is null ----Filter out all historical data;

----Transformation
Select prd_key, count(*) From(
Select 
pn.prd_id as product_id,
pn.prd_key as product_number,
pn.prd_nm as product_name,
pn.cat_id as category_id,
pc.CAT as category,
pc.SUBCAT as subcategory,
pc.MAINTENANCE as maintenance,
pn.prd_cost as cost,
pn.prd_line as product_line,
pn.prd_start_dt as start_date
from 
Silver.crm_prd_info pn
left join
Silver.erp_px_cat_g1v2 pc
on pn.cat_id = pc.ID
where prd_end_dt is null ----Filter out all historical data
)t group by prd_key 
Having count(*) >1;

Select * from gold.dim_products;

create view gold.fact_sales as
Select 
sd.sls_ord_num as order_number,
pr.product_key,
cu.Customer_key,
sd.sls_order_dt as order_date,
sd.sls_ship_dt as ship_date,
sd.sls_due_dt as due_date,
sd.sls_sales as sales,
sd.sls_quantity as quantity,
sd.sls_price as price
from Silver.crm_sales_details sd
left join gold.dim_products pr
on sd.sls_prd_key = pr.product_number
left join gold.dim_customers cu
on sd.sls_cust_id = cu.Customer_id;

Select * from gold.fact_sales;


---- foriegn key integrity (Dimensions)
Select * from gold.fact_sales f
left join gold.dim_customers c
on c.Customer_key = f.Customer_key
left join gold.dim_products p
on p.product_key = f.product_key
where p.product_key is null;

